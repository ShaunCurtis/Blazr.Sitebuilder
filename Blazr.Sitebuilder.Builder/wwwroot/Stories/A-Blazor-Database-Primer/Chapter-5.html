<!DOCTYPE html>
<html lang="en"><head><meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<base href="/">

	

	

	
	<link href="/assets/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
	<link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">

	
	<link href="/assets/css/sb-admin-2.css" rel="stylesheet" type="text/css">
	<link href="/assets/css/site.css" rel="stylesheet" type="text/css">

	
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
	<link rel="stylesheet" href="/assets/css/article.css" type="text/css">

	
	<link rel="icon" href="/assets/images/favicon.png">

	<title>Chapter 5 - Adding a WASM SPA to the Solution</title>
        <meta property="author" content="Shaun Curtis" />
        <meta property="description" content="This chapter looks at how to structure the solution to run as an WASM SPA." />
    <meta property="og:site_name" content="Cold Elm Coders" />
        <meta property="og:site" content="https://shauncurtis.github.io/" />
        <meta property="og:title" content="Chapter 5 - Adding a WASM SPA to the Solution" />
        <meta property="og:description" content="This chapter looks at how to structure the solution to run as an WASM SPA." /></head>
<body><header class="navbar bg-dark p-2 text-large text-light"><section class="navbar-section  text-light"><a href="/" class="navbar-brand mr-2 text-large text-light p-2">Cold Elm Coders</a>
			<a href="/Posts" class="btn btn-link text-light">Posts</a>
			<a href="/Rants" class="btn btn-link text-light">Rants</a>
			<a href="/Articles" class="btn btn-link text-light">Articles</a>
			<a href="/Stories" class="btn btn-link text-light">Stories</a>
			<a href="/Tags" class="btn btn-link text-light">Tags</a></section></header>

	<div class="container-fluid"><div class="row"><div class="col-12 col-sm-3 col-lg-2 bg-light pt-2"><div class="article-info p-2"><div class="mb-2">Published: 13-Aug-2021</div>
                <div class="mb-2">Updated: 13-Aug-2021</div>
                <div class="mb-2">Author: Shaun Curtis</div></div>
    <h4 class="p-2">Table of Contents</h4>
<ul class="TOC" >
<li class="TOC-item TOC-item-0" >
<a class="TOC-link" href="#">Top</a>
<ul class="TOC TOC-0" >
<li class="TOC-item TOC-item-1" >
<ul class="TOC TOC-1" >
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#projects">Projects</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#blazr.primer.controllers">Blazr.Primer.Controllers</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#blazordb.data">BlazorDB.Data</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#blazr.primer">Blazr.Primer</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#blazordb.wasm">BlazorDB.WASM</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#blazordb.ui">BlazorDB.UI</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#navmenu">NavMenu</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#blazordb.web">BlazorDB.Web</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#how-does-all-this-work">How does all this Work?</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
			
			<div class="col-12 col-sm-9 col-lg-10 p-2"><div class="pt-2 pb-2 border-bottom mb-4 text-primary"><h1>Chapter 5 - Adding a WASM SPA to the Solution</h1>
            <div><small>This chapter looks at how to structure the solution to run as an WASM SPA.</small></div></div>
    <div class="mb-2"><h3>Document List</h3>
        <ul><li><a href="/Stories/A-Blazor-Database-Primer/Index.html">A Blazor Database Primer</a></li><li><a href="/Stories/A-Blazor-Database-Primer/Chapter-1.html">Chapter 1 - Project Design and Structure</a></li><li><a href="/Stories/A-Blazor-Database-Primer/Chapter-2.html">Chapter 2 - The Data Store and Data Classes</a></li><li><a href="/Stories/A-Blazor-Database-Primer/Chapter-3.html">Chapter 3 - The Business and Application Code</a></li><li><a href="/Stories/A-Blazor-Database-Primer/Chapter-4.html">Chapter 4 - Setting up the Solution to Run</a></li><li><a href="/Stories/A-Blazor-Database-Primer/Chapter-5.html">Chapter 5 - Adding a WASM SPA to the Solution</a></li><li><a href="/Stories/A-Blazor-Database-Primer/Chapter-6.html">Chapter 6 -  Rebuilding FetchData</a></li><li><a href="/Stories/A-Blazor-Database-Primer/Chapter-7.html">Chapter 7 - Adding Sorting and Paging to the List Form</a></li></ul></div>
    <p>Developing a Blazor application in Server mode is much easier than in WASM mode.  However, you probably want to deploy your application as a WASM solution.</p>
<p>In this chapter we'll look at how to build and run Server and WASM SPA side-by-side from the same web server/site.</p>
<h2 id="projects">Projects</h2>
<p>We need to add two new projects to the solution:</p>
<ol>
<li><em>Blazr.Primer.WASM</em> using the <em>Blazor WebAssembly App</em> template.</li>
<li><em>Blazr.Primer.Controllers</em> using the <em>ASP.NET Core Web App</em> template.</li>
</ol>
<p>Clear both projects down to only <em>program.cs</em>.</p>
<h2 id="blazr.primer.controllers">Blazr.Primer.Controllers</h2>
<p>This project holds the API controllers.  It uses the <code>Microsoft.NET.Sdk.Web</code> Framework to implement controllers.</p>
<p>Remove everything but <em>Program.cs</em>.</p>
<pre><code class="language-xml">&lt;Project Sdk=&quot;Microsoft.NET.Sdk.Web&quot;&gt;

  &lt;PropertyGroup&gt;
    &lt;TargetFramework&gt;net5.0&lt;/TargetFramework&gt;
  &lt;/PropertyGroup&gt;

  &lt;ItemGroup&gt;
    &lt;ProjectReference Include=&quot;..\Blazr.Primer.Core\Blazr.Primer.Core.csproj&quot; /&gt;
  &lt;/ItemGroup&gt;

&lt;/Project&gt;
</code></pre>
<p>As we only have a single data class, we implement a single controller <code>WeatherForecastController</code>.</p>
<h3 id="controllers">Controllers</h3>
<p>Add <code>WeatherForecastController</code> to <em>Blazr.Primer.Controllers/Controllers</em>.</p>
<p>The controller constructor defines a <code>IDataBroker</code> argument.</p>
<pre><code class="language-csharp">using Blazr.Primer.Core;
using Microsoft.AspNetCore.Mvc;
using System.Collections.Generic;
using System.Threading.Tasks;
using MVC = Microsoft.AspNetCore.Mvc;

namespace Blazr.Primer.Controllers
{
    [ApiController]
    public class WeatherForecastController : ControllerBase
    {
        protected IDataBroker DataService { get; set; }

        public WeatherForecastController(IDataBroker dataService)
        {
            this.DataService = dataService;
        }

        [MVC.Route(&quot;/api/weatherforecast/list&quot;)]
        [HttpGet]
        public async Task&lt;List&lt;WeatherForecast&gt;&gt; GetListAsync() =&gt; await DataService.SelectAllRecordsAsync&lt;WeatherForecast&gt;();
    }
}
</code></pre>
<h3 id="program.cs">Program.cs</h3>
<p>A web project must have a <code>Main</code>.  It's not used, so we define an empty one.</p>
<pre><code class="language-csharp">namespace Blazr.Primer.Controllers
{
    public class Program
    {
        public static void Main(string[] args) { }
    }
}
</code></pre>
<h2 id="blazordb.data">BlazorDB.Data</h2>
<p>We need a new data broker to handle API requests from the WASM SPA.  This is where our design starts to come into play.  The new <code>APIDataBroker</code> simply replaces the <code>ServerDataBroker</code> in the WASM SPA Services Container.  The <code>DataConnector</code> doesn't need to know that the dat broker has changed.  It simply gets handed a class that implements <code>IDataBroker</code> and has a <code>SelectAllRecordsAsync&lt;TRecord&gt;()</code> method it can call.</p>
<p>The diagram below shows the Services setup for the two versions of the SPA.</p>
<p><img src="/siteimages/Articles/DB-Primer/SPA-Services.png" alt="WASM Page Filesystem" /></p>
<h3 id="apidatabroker">APIDataBroker</h3>
<p>Add an <code>APIDataBroker</code> class to the <em>Brokers</em> folder.</p>
<pre><code class="language-csharp">using Blazr.Primer.Core;
using System.Collections.Generic;
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;

namespace Blazr.Primer.Data
{
    public class APIDataBroker : DataBroker, IDataBroker
    {
        protected HttpClient HttpClient { get; set; }

        public APIDataBroker(HttpClient httpClient)
            =&gt; this.HttpClient = httpClient;

        public override async ValueTask&lt;List&lt;TRecord&gt;&gt; SelectAllRecordsAsync&lt;TRecord&gt;()
            =&gt; await this.HttpClient.GetFromJsonAsync&lt;List&lt;TRecord&gt;&gt;($&quot;/api/{GetRecordName&lt;TRecord&gt;()}/list&quot;);

        protected string GetRecordName&lt;TRecord&gt;() where TRecord : class, IRecord, new()
            =&gt; new TRecord().GetType().Name;

    }
}
</code></pre>
<p>This is a generic data broker.  As long as we stick to naming convertions - controllers with a path <em>API/DataClassName/xxx</em> - we can use boilerplate code.</p>
<ol>
<li><code>GetRecordName</code> gets the record class name.</li>
<li>The service gets the <code>HttpClient</code> registered in the Services container.</li>
</ol>
<h2 id="blazr.primer">Blazr.Primer</h2>
<h3 id="servicecollectionextensions">ServiceCollectionExtensions</h3>
<p>Update <code>AddWASMApplicationServices</code> to include adding the <code>APIDataBroker</code> as the <code>IDataBroker</code> service.</p>
<pre><code class="language-csharp">    public static IServiceCollection AddWASMApplicationServices(this IServiceCollection services)
    {
        services.AddScoped&lt;IDataBroker, APIDataBroker&gt;();
        AddCommonServices(services);
        return services;
    }
</code></pre>
<h2 id="blazordb.wasm">BlazorDB.WASM</h2>
<p>This project builds the WASM code and associated configuration and JS files.</p>
<p>Remove except <em>program.cs</em>.</p>
<h3 id="project-file">Project file</h3>
<pre><code class="language-xml">The project file should look like this:

```xml
&lt;Project Sdk=&quot;Microsoft.NET.Sdk.BlazorWebAssembly&quot;&gt;

  &lt;PropertyGroup&gt;
    &lt;StaticWebAssetBasePath&gt;wasm&lt;/StaticWebAssetBasePath&gt;
    &lt;TargetFramework&gt;net5.0&lt;/TargetFramework&gt;
  &lt;/PropertyGroup&gt;

    &lt;ItemGroup&gt;
    &lt;PackageReference Include=&quot;Microsoft.AspNetCore.Components.WebAssembly&quot; Version=&quot;5.0.9&quot; /&gt;
    &lt;PackageReference Include=&quot;Microsoft.AspNetCore.Components.WebAssembly.DevServer&quot; Version=&quot;5.0.9&quot; PrivateAssets=&quot;all&quot; /&gt;
    &lt;PackageReference Include=&quot;System.Net.Http.Json&quot; Version=&quot;5.0.0&quot; /&gt;
  &lt;/ItemGroup&gt;

  &lt;ItemGroup&gt;
    &lt;ProjectReference Include=&quot;..\Blazr.Primer.UI\Blazr.Primer.UI.csproj&quot; /&gt;
    &lt;ProjectReference Include=&quot;..\Blazr.Primer\Blazr.Primer.csproj&quot; /&gt;
  &lt;/ItemGroup&gt;

&lt;/Project&gt;
</code></pre>
<h3 id="program.cs-1">Program.cs</h3>
<pre><code class="language-csharp">using Blazr.Primer.SPA;
using Microsoft.AspNetCore.Components.WebAssembly.Hosting;
using Microsoft.Extensions.DependencyInjection;
using System;
using System.Net.Http;
using System.Threading.Tasks;

namespace Blazr.Primer.WASM
{
    public class Program
    {
        public static async Task Main(string[] args)
        {
            var builder = WebAssemblyHostBuilder.CreateDefault(args);
            builder.RootComponents.Add&lt;Blazr.Primer.UI.Components.App&gt;(&quot;#app&quot;);

            builder.Services.AddWASMApplicationServices();
            builder.Services.AddScoped(sp =&gt; new HttpClient { BaseAddress = new Uri(builder.HostEnvironment.BaseAddress) });

            await builder.Build().RunAsync();
        }
    }
}
</code></pre>
<ol>
<li>Sets the root component to <code>Blazr.Primer.UI.App</code> - the same <code>App</code> as used by the Server project.</li>
<li>Adds the services defined in the <em>BlazorDB</em> <code>ServiceCollectionExtensions</code>.</li>
<li>Adds a <code>HttpClient</code> service to make API calls.</li>
</ol>
<h3 id="project-file-1">Project File</h3>
<p>The project file should look like this:</p>
<pre><code class="language-xml">&lt;Project Sdk=&quot;Microsoft.NET.Sdk.BlazorWebAssembly&quot;&gt;

  &lt;PropertyGroup&gt;
    &lt;StaticWebAssetBasePath&gt;wasm&lt;/StaticWebAssetBasePath&gt;
    &lt;TargetFramework&gt;net5.0&lt;/TargetFramework&gt;
  &lt;/PropertyGroup&gt;

    &lt;ItemGroup&gt;
    &lt;PackageReference Include=&quot;Microsoft.AspNetCore.Components.WebAssembly&quot; Version=&quot;5.0.9&quot; /&gt;
    &lt;PackageReference Include=&quot;Microsoft.AspNetCore.Components.WebAssembly.DevServer&quot; Version=&quot;5.0.9&quot; PrivateAssets=&quot;all&quot; /&gt;
    &lt;PackageReference Include=&quot;System.Net.Http.Json&quot; Version=&quot;5.0.0&quot; /&gt;
  &lt;/ItemGroup&gt;

  &lt;ItemGroup&gt;
    &lt;ProjectReference Include=&quot;..\Blazr.Primer.UI\Blazr.Primer.UI.csproj&quot; /&gt;
    &lt;ProjectReference Include=&quot;..\Blazr.Primer\Blazr.Primer.csproj&quot; /&gt;
  &lt;/ItemGroup&gt;

&lt;/Project&gt;
</code></pre>
<p>How does this work?  There's no code?</p>
<p>The all important bit is the definition of the root component in <code>Main</code>.  This creates the dependancy links so all the necessary project DLLs get compiled into the WASM code base.</p>
<p><code>&lt;StaticWebAssetBasePath&gt;</code> sets the subdirectory the WASM code base is available through in the compiled code.  The image below shows the browser Filesystem for the running WASM SPA.</p>
<p><img src="/siteimages/Articles/DB-Primer/Wasm-Page-Filesystem.png" alt="WASM Page Filesystem" /></p>
<h2 id="blazordb.ui">BlazorDB.UI</h2>
<p>Add additional <code>@page</code> definitions for each <em>RouteView</em>.</p>
<p>Index.razor</p>
<pre><code class="language-html">@page &quot;/&quot;
@page &quot;/index&quot;
@page &quot;/wasm/index&quot;
</code></pre>
<p>Counter.razor</p>
<pre><code class="language-html">@page &quot;/counter&quot;
@page &quot;/wasm/counter&quot;
</code></pre>
<p>FetchData.razor</p>
<pre><code class="language-html">@page &quot;/fetchdata&quot;
@page &quot;/wasm/fetchdata&quot;
</code></pre>
<h3 id="mainlayout">MainLayout</h3>
<p>Update <code>MainLayout</code>.</p>
<pre><code class="language-html">@inherits LayoutComponentBase
@namespace Blazr.Primer.UI.Components

&lt;div class=&quot;page&quot;&gt;
    &lt;div class=&quot;@_sidebarCss&quot;&gt;
        &lt;NavMenu /&gt;
    &lt;/div&gt;

    &lt;div class=&quot;main&quot;&gt;
        &lt;div class=&quot;top-row px-4&quot;&gt;
            &lt;a href=&quot;https://docs.microsoft.com/aspnet/&quot; target=&quot;_blank&quot;&gt;About&lt;/a&gt;
        &lt;/div&gt;

        &lt;div class=&quot;content px-4&quot;&gt;
            @Body
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<pre><code class="language-csharp">@code 
{
    [Inject] NavigationManager NavManager { get; set; }
    private bool _isWasm =&gt; NavManager?.Uri.Contains(&quot;wasm&quot;, StringComparison.CurrentCultureIgnoreCase) ?? false;
    private string _sidebarCss =&gt; _isWasm ? &quot;sidebar sidebar-teal&quot; : &quot;sidebar sidebar-steel&quot;;
}
</code></pre>
<p>And MainLayout.razor.css</p>
<pre><code class="language-css">.... /*line 10*/
.sidebar {
    background-image: linear-gradient(180deg, rgb(5, 39, 103) 0%, #3a0647 70%);
}

/* Added Styles*/
.sidebar-teal {
    background-image: linear-gradient(180deg, rgb(0, 64, 128) 0%, rgb(0,96,192) 70%);
}

.sidebar-steel {
    background-image: linear-gradient(180deg, #2a3f4f 0%, #446680 70%);
}
/* End Added Styles*/
.....
</code></pre>
<p>The component checks the URL and if it contains &quot;wasm&quot; it changes the sidebar colour.</p>
<h2 id="navmenu">NavMenu</h2>
<p>Update <code>NavMenu</code></p>
<pre><code class="language-html">@namespace Blazr.Primer.UI.Components

&lt;div class=&quot;top-row pl-4 navbar navbar-dark&quot;&gt;
    @*Change title*@
    &lt;a class=&quot;navbar-brand&quot; href=&quot;&quot;&gt;@_title&lt;/a&gt;
    &lt;button class=&quot;navbar-toggler&quot; @onclick=&quot;ToggleNavMenu&quot;&gt;
        &lt;span class=&quot;navbar-toggler-icon&quot;&gt;&lt;/span&gt;
    &lt;/button&gt;
&lt;/div&gt;

&lt;div class=&quot;@NavMenuCssClass&quot; @onclick=&quot;ToggleNavMenu&quot;&gt;
    &lt;ul class=&quot;nav flex-column&quot;&gt;
        @*Add links bewteen contexts*@
        &lt;li class=&quot;nav-item px-3&quot;&gt;
            &lt;NavLink class=&quot;nav-link&quot; href=&quot;@_otherContextUrl&quot; Match=&quot;NavLinkMatch.All&quot;&gt;
                &lt;span class=&quot;oi oi-home&quot; aria-hidden=&quot;true&quot;&gt;&lt;/span&gt; @_otherContextLinkName
            &lt;/NavLink&gt;
        &lt;/li&gt;
        &lt;li class=&quot;nav-item px-3&quot;&gt;
            &lt;NavLink class=&quot;nav-link&quot; href=&quot;&quot; Match=&quot;NavLinkMatch.All&quot;&gt;
                &lt;span class=&quot;oi oi-home&quot; aria-hidden=&quot;true&quot;&gt;&lt;/span&gt; Home
            &lt;/NavLink&gt;
        &lt;/li&gt;
        &lt;li class=&quot;nav-item px-3&quot;&gt;
            &lt;NavLink class=&quot;nav-link&quot; href=&quot;counter&quot;&gt;
                &lt;span class=&quot;oi oi-plus&quot; aria-hidden=&quot;true&quot;&gt;&lt;/span&gt; Counter
            &lt;/NavLink&gt;
        &lt;/li&gt;
        &lt;li class=&quot;nav-item px-3&quot;&gt;
            &lt;NavLink class=&quot;nav-link&quot; href=&quot;fetchdata&quot;&gt;
                &lt;span class=&quot;oi oi-list-rich&quot; aria-hidden=&quot;true&quot;&gt;&lt;/span&gt; Fetch data
            &lt;/NavLink&gt;
        &lt;/li&gt;
        &lt;li class=&quot;nav-item px-3&quot;&gt;
            &lt;NavLink class=&quot;nav-link&quot; href=&quot;weatherforecasts&quot;&gt;
                &lt;span class=&quot;oi oi-list-rich&quot; aria-hidden=&quot;true&quot;&gt;&lt;/span&gt; WeatherForecasts
            &lt;/NavLink&gt;
        &lt;/li&gt;
    &lt;/ul&gt;
&lt;/div&gt;
</code></pre>
<pre><code class="language-csharp">@code {

    [Inject] NavigationManager NavManager { get; set; }

    private bool _isWasm =&gt; NavManager?.Uri.Contains(&quot;wasm&quot;, StringComparison.CurrentCultureIgnoreCase) ?? false;

    private string _otherContextUrl =&gt; _isWasm ? &quot;/&quot; : &quot;/wasm&quot;;

    private string _otherContextLinkName =&gt; _isWasm ? &quot;Server Home&quot; : &quot;WASM Home&quot;;

    private string _title =&gt; _isWasm ? &quot;BlazorDB WASM&quot; : &quot;BlazorDB Server&quot;;

    private bool collapseNavMenu = true;

    private string NavMenuCssClass =&gt; collapseNavMenu ? &quot;collapse&quot; : null;

    private void ToggleNavMenu()
    {
        collapseNavMenu = !collapseNavMenu;
    }
}
</code></pre>
<p>The component uses the URL to set the correct title and navigation options for WASM or Server mode.</p>
<h2 id="blazordb.web">BlazorDB.Web</h2>
<h3 id="project-file-2">Project File</h3>
<p>The project file should look like this:</p>
<pre><code class="language-xml">&lt;Project Sdk=&quot;Microsoft.NET.Sdk.Web&quot;&gt;

  &lt;PropertyGroup&gt;
    &lt;TargetFramework&gt;net5.0&lt;/TargetFramework&gt;
  &lt;/PropertyGroup&gt;

  &lt;ItemGroup&gt;
    &lt;PackageReference Include=&quot;Microsoft.AspNetCore.Components.WebAssembly.Server&quot; Version=&quot;5.0.9&quot; /&gt;
  &lt;/ItemGroup&gt;

  &lt;ItemGroup&gt;
    &lt;ProjectReference Include=&quot;..\Blazr.Primer.Controllers\Blazr.Primer.Controllers.csproj&quot; /&gt;
    &lt;ProjectReference Include=&quot;..\Blazr.Primer.Core\Blazr.Primer.Core.csproj&quot; /&gt;
    &lt;ProjectReference Include=&quot;..\Blazr.Primer.Data\Blazr.Primer.Data.csproj&quot; /&gt;
    &lt;ProjectReference Include=&quot;..\Blazr.Primer.WASM\Blazr.Primer.WASM.csproj&quot; /&gt;
    &lt;ProjectReference Include=&quot;..\Blazr.Primer\Blazr.Primer.csproj&quot; /&gt;
    &lt;ProjectReference Include=&quot;..\Blazr.Primer.UI\Blazr.Primer.UI.csproj&quot; /&gt;
  &lt;/ItemGroup&gt;

&lt;/Project&gt;
</code></pre>
<h3 id="wasm.cshtml">_WASM.cshtml</h3>
<p>Add a <em>_WASM.cshtml</em> file to the <em>Pages</em> folder.  This is the launch page for the WASM SPA.</p>
<pre><code class="language-html">@page &quot;/wasm&quot;
@namespace BlazorDB.Web.Pages
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    Layout = null;
}

&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot; /&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot; /&gt;
    &lt;title&gt;BlazorDB.WASM&lt;/title&gt;
    &lt;base href=&quot;/wasm/&quot; /&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;/css/bootstrap/bootstrap.min.css&quot; /&gt;
    &lt;link href=&quot;/css/site.css&quot; rel=&quot;stylesheet&quot; /&gt;
    &lt;link href=&quot;/BlazorDB.Web.styles.css&quot; rel=&quot;stylesheet&quot; /&gt;
&lt;/head&gt;
&lt;body&gt;

&lt;div id=&quot;app&quot;&gt;
        &lt;div class=&quot;mt-4&quot; style=&quot;margin-right:auto; margin-left:auto; width:100%;&quot;&gt;
            &lt;div class=&quot;loader&quot;&gt;&lt;/div&gt;
            &lt;div style=&quot;width:100%; text-align:center;&quot;&gt;&lt;h4&gt;Web Application Loading&lt;/h4&gt;&lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;

    &lt;div id=&quot;blazor-error-ui&quot;&gt;
        An unhandled error has occurred.
        &lt;a href=&quot;&quot; class=&quot;reload&quot;&gt;Reload&lt;/a&gt;
        &lt;a class=&quot;dismiss&quot;&gt;ðŸ—™&lt;/a&gt;
    &lt;/div&gt;
    &lt;script src=&quot;/wasm/_framework/blazor.webassembly.js&quot;&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h3 id="site.css">Site.css</h3>
<p>Add the following css to <em>Blazr.Primer.Web/wwwroot/css/site.css</em>.  It formats the Css in <code>&lt;div id=&quot;app&quot;&gt;</code> to give a pretty spinner.</p>
<pre><code class="language-css">.page-loader {
    position: absolute;
    left: 50%;
    top: 50%;
    z-index: 1;
    width: 150px;
    height: 150px;
    margin: -75px 0 0 -75px;
    border: 16px solid #f3f3f3;
    border-radius: 50%;
    border-top: 16px solid #3498db;
    width: 120px;
    height: 120px;
    -webkit-animation: spin 2s linear infinite;
    animation: spin 2s linear infinite;
}

.loader {
    border: 16px solid #f3f3f3;
    /* Light grey */
    border-top: 16px solid #3498db;
    /* Blue */
    border-radius: 50%;
    width: 120px;
    height: 120px;
    animation: spin 2s linear infinite;
    margin-left: auto;
    margin-right: auto;
}

@-webkit-keyframes spin {
    0% {
        -webkit-transform: rotate(0deg);
    }
    100% {
        -webkit-transform: rotate(360deg);
    }
}

@keyframes spin {
    0% {
        transform: rotate(0deg);
    }
    100% {
        transform: rotate(360deg);
    }
}
</code></pre>
<h3 id="startup">Startup</h3>
<p><code>Startup</code> is where the magic exists to make the two SPA's run together.</p>
<p>In <code>ConfigureServices</code> we add the Controllers, specifying where to find the controllers.</p>
<pre><code class="language-csharp">    public void ConfigureServices(IServiceCollection services)
    {
        services.AddRazorPages();
        services.AddServerSideBlazor();
        services.AddServerApplicationServices();
        services.AddControllers().PartManager.ApplicationParts.Add(new AssemblyPart(typeof(BlazorDB.Controllers.Program).Assembly));
    }
</code></pre>
<p>In <code>Configure</code> we add a new middleware section based on mapping.  All URLs to <em>/wasm</em> get mapped to <em>_WASM.cshtml</em></p>
<pre><code class="language-csharp">    public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
    {
        if (env.IsDevelopment())
        {
            app.UseDeveloperExceptionPage();
        }
        else
        {
            app.UseExceptionHandler(&quot;/Error&quot;);
            // The default HSTS value is 30 days. You may want to change this for production scenarios, see https://aka.ms/aspnetcore-hsts.
            app.UseHsts();
        }

        app.UseHttpsRedirection();
        app.UseStaticFiles();

        app.MapWhen(ctx =&gt; ctx.Request.Path.StartsWithSegments(&quot;/wasm&quot;), app1 =&gt;
        {
            app1.UseBlazorFrameworkFiles(&quot;/wasm&quot;);
            app1.UseRouting();
            app1.UseEndpoints(endpoints =&gt;
            {
                endpoints.MapFallbackToPage(&quot;/wasm/{*path:nonfile}&quot;, &quot;/_WASM&quot;);
            });

        });

        app.UseRouting();

        app.UseEndpoints(endpoints =&gt;
        {
            endpoints.MapControllers();
            endpoints.MapBlazorHub();
            endpoints.MapFallbackToPage(&quot;/_Host&quot;);
        });
    }
</code></pre>
<h2 id="how-does-all-this-work">How does all this Work?</h2>
<p>Lets look at some scenarios to understand what's going on.</p>
<h3 id="browsing-to-the-site-httpsmysite.com">Browsing to the Site - <a href="https://mysite.com/">https://mysite.com/</a></h3>
<p><code>Startup.Config</code> runs and uses the default endpoint mapping which maps a fallback page <em>/_Host</em> i.e. <em>_Host.cshtml</em>.  This is the Blazor Server startup page so the Blazor Server SPA starts.</p>
<h3 id="browsing-directly-to-the-wasm-site-httpsmysite.comwasm">Browsing directly to the WASM Site - <a href="https://mysite.com/wasm">https://mysite.com/wasm</a></h3>
<p><code>Startup.Config</code> runs and uses the WASM endpoint mapping as the URL matches <code>Request.Path.StartsWithSegments(&quot;/wasm&quot;)</code>.  This maps to a fallback page <em>/_WASM</em> i.e. <em>_WASM.cshtml</em>.  This is the Blazor WASM startup page so the Blazor WASM SPA starts.</p>
<h3 id="clicking-on-the-wasm-link-in-the-server-spa-httpsmysite.comwasm">Clicking on the WASM link in the Server SPA - <a href="https://mysite.com/wasm">https://mysite.com/wasm</a></h3>
<p>The server <code>Router</code> doesn't recognise the route so it forces a browser page load for the URL.  This is now the same as <em>Browsing directly to the WASM Site</em> above.</p>
<h3 id="browsing-directly-to-httpsmysite.comcounter">Browsing directly to <a href="https://mysite.com/counter">https://mysite.com/counter</a></h3>
<p><code>Startup.Config</code> runs and uses the default endpoint mapping which maps a fallback page <em>/_Host</em> i.e. <em>_Host.cshtml</em>.  ..... as above.</p>
<h3 id="browsing-directly-to-httpsmysite.comwasmcounter">Browsing directly to <a href="https://mysite.com/wasm/counter">https://mysite.com/wasm/counter</a></h3>
<p><code>Startup.Config</code> runs and uses the WASM endpoint mapping as the URL matches <code>Request.Path.StartsWithSegments(&quot;/wasm&quot;)</code>.  This maps to a fallback page <em>/_WASM</em> i.e. <em>_WASM.cshtml</em>.  ..... as above.</p>
<h3 id="clicking-a-link-within-the-server-spa-to-counter-httpsmysite.comcounter">Clicking a link within the Server SPA to Counter - <a href="https://mysite.com/counter">https://mysite.com/counter</a></h3>
<p>The server <code>Router</code> recognises the route and loads the appropriate RouteView component.  No page loading takes place.</p>
<h3 id="clicking-a-link-within-the-wasm-spa-to-counter-httpsmysite.comcounter">Clicking a link within the WASM SPA to Counter - <a href="https://mysite.com/counter">https://mysite.com/counter</a></h3>
<p>The server <code>Router</code> recognises the route and loads the appropriate RouteView component.  No page loading takes place.</p>
</div></div></div></body></html>





